<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#1a1a1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Initiation</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { width: 100%; max-width: 100vw; overflow-x: hidden; }
    body {
      font-family: 'Crimson Text', Georgia, serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #e0e0e0;
      overflow-x: hidden;
      min-height: 100vh;
      width: 100%;
      max-width: 100vw;
    }

    .container { padding: 20px; max-width: 650px; margin: 0 auto; min-height: 100vh; width: 100%; }

    .title {
      font-size: clamp(1.3rem, 5vw, 2.5rem);
      text-align: center;
      margin: 30px 0 50px;
      font-weight: 300;
      letter-spacing: clamp(3px, 2vw, 8px);
      text-transform: uppercase;
      color: #f5f5f5;
      text-shadow: 0 0 20px rgba(255,255,255,0.1);
    }

    .gate-title {
      font-size: clamp(1rem, 3.5vw, 1.3rem);
      margin-bottom: 30px;
      text-align: center;
      padding-bottom: 15px;
      font-weight: 300;
      letter-spacing: clamp(2px, 1.5vw, 4px);
      color: #c9a961;
      border-bottom: 1px solid rgba(201, 169, 97, 0.3);
    }

    .gate-content {
      background: rgba(30, 30, 30, 0.8);
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(201, 169, 97, 0.2);
      line-height: 2;
    }

    .verse {
      margin: 25px 0;
      padding: 20px;
      border-left: 2px solid rgba(201, 169, 97, 0.5);
      font-style: italic;
      color: #c9a961;
      line-height: 1.8;
    }

    .image-container {
      margin: 30px 0;
      text-align: center;
      border: 2px solid rgba(201, 169, 97, 0.4);
      padding: 18px;
      background: rgba(0,0,0,0.5);
    }

    .image-caption {
      margin-top: 12px;
      font-style: italic;
      color: #c9a961;
      font-size: 0.9rem;
      letter-spacing: 2px;
    }

    input {
      width: 100%;
      padding: 18px;
      font-size: 1.05rem;
      font-family: 'Courier New', monospace;
      background: rgba(30, 30, 30, 0.9);
      color: #e0e0e0;
      border: 1px solid rgba(201, 169, 97, 0.3);
      margin-bottom: 15px;
    }

    button {
      width: 100%;
      padding: 16px;
      font-size: 1.05rem;
      font-family: Georgia, serif;
      background: rgba(201, 169, 97, 0.15);
      color: #c9a961;
      border: 1px solid rgba(201, 169, 97, 0.4);
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.2s ease;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    button:hover { background: rgba(201, 169, 97, 0.2); }

    .feedback {
      padding: 18px;
      margin: 18px 0;
      text-align: center;
      font-size: 1.15rem;
      font-style: italic;
      letter-spacing: 2px;
      border: 1px solid transparent;
    }
    .success { background: rgba(76, 175, 80, 0.1); color: #81c784; border-color: rgba(76, 175, 80, 0.3); }
    .error   { background: rgba(244, 67, 54, 0.1); color: #e57373; border-color: rgba(244, 67, 54, 0.3); }

    .admin-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(201, 169, 97, 0.15);
      color: #c9a961;
      border: 1px solid rgba(201, 169, 97, 0.4);
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 1000;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: #1a1a1a;
      padding: 25px;
      border: 1px solid rgba(201, 169, 97, 0.3);
      width: 92%;
      max-width: 520px;
    }

    /* Gate V (tile phrase) */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin: 25px 0;
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
    }
    .grid-cell {
      aspect-ratio: 1;
      border: 1px solid rgba(201, 169, 97, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(30, 30, 30, 0.8);
      color: #c9a961;
      font-size: 0.85rem;
    }
    .tile-option {
      padding: 10px 12px;
      border: 1px solid rgba(201, 169, 97, 0.3);
      margin: 4px;
      background: rgba(30, 30, 30, 0.8);
      color: #c9a961;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 48px;
      text-align: center;
      flex-shrink: 0;
      user-select: none;
    }

    /* FINAL JIGSAW (32 pieces, 8x4) */
    .jigsaw-container { max-width: 760px; margin: 30px auto; }
    .jigsaw-scroll { overflow-x: auto; padding-bottom: 8px; }
    .jigsaw-grid {
      display: grid;
      gap: 4px;
      margin: 16px auto;
      background: rgba(201, 169, 97, 0.08);
      padding: 4px;
      border: 2px solid rgba(201, 169, 97, 0.3);
      grid-template-columns: repeat(8, minmax(34px, 1fr));
      max-width: 740px;
      min-width: 560px;
    }
    .jigsaw-piece {
      aspect-ratio: 1;
      cursor: pointer;
      border: 2px solid rgba(201, 169, 97, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      background-repeat: no-repeat;
      background-color: rgba(0,0,0,0.2);
    }
    .jigsaw-piece:active { transform: scale(0.96); }

    .final-reveal {
      text-align: center;
      padding: 100px 18px;
      animation: fadeIn 2.2s ease-in;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .title { margin: 20px 0 30px; }
      .gate-content { padding: 20px 14px; font-size: 0.95rem; }
      .verse { padding: 14px; font-size: 0.9rem; line-height: 1.6; margin: 18px 0; }
      .image-container { padding: 12px; margin: 18px 0; }
      input { padding: 14px; font-size: 1rem; }
      button { padding: 14px; font-size: 1rem; }
      .grid-container { gap: 4px; }
      .grid-cell { font-size: 0.65rem; min-height: 34px; }
      .tile-option { padding: 8px 10px; font-size: 0.8rem; min-width: 44px; }
      .feedback { font-size: 1rem; padding: 14px; }
      .admin-btn { width: 40px; height: 40px; font-size: 1.05rem; top: 10px; right: 10px; }
      .modal-content { width: 96%; padding: 18px; }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ========= CONFIG =========
    const HOST_PIN = '7734'; // CHANGE THIS

    const GATES = {
      1: { title: 'GATE I',    answer: 'LET' },
      2: { title: 'GATE II',   answer: 'US' },
      3: { title: 'GATE III',  answer: 'JUDGE' },
      4: { title: 'GATE IV',   answer: 'KEBAB' },
      5: { title: 'GATE V',    answer: 'SLOW FIRE MAKES MEAT TENDER' },
      6: { title: 'GATE VI',   answer: 'WHERE' },
      7: { title: 'GATE VII',  answer: 'FIRE' },
      8: { title: 'GATE VIII', answer: 'LEARNED' },
      9: { title: 'GATE IX',   answer: 'PATIENCE' }
    };

    // Final phrase Stefano must reconstruct (not shown automatically)
    const FINAL_PHRASE = "LET US JUDGE KEBAB WHERE FIRE LEARNED PATIENCE";

    // Destination guess settings
    const DESTINATION_ACCEPT = ["TURKEY"]; // you can add "TÜRKİYE" if you want
    const DESTINATION_MAX_ATTEMPTS = 2;    // after this many wrong tries -> jigsaw fallback

    // SVG artwork
    const IMAGES = {
      gate1: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <circle cx="200" cy="150" r="80" fill="none" stroke="#c9a961" stroke-width="3"/>
        <path d="M 200 70 L 200 230" stroke="#c9a961" stroke-width="3"/>
        <path d="M 120 150 L 280 150" stroke="#c9a961" stroke-width="3"/>
        <circle cx="200" cy="150" r="40" fill="none" stroke="#c9a961" stroke-width="2" stroke-dasharray="5,5"/>
        <text x="200" y="270" font-family="Georgia" font-size="16" fill="#c9a961" text-anchor="middle" font-style="italic">The key is the lock</text>
      </svg>`,

      gate2: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <circle cx="150" cy="150" r="60" fill="none" stroke="#c9a961" stroke-width="3"/>
        <circle cx="250" cy="150" r="60" fill="none" stroke="#c9a961" stroke-width="3"/>
        <path d="M 150 90 Q 200 120 250 90" fill="none" stroke="#c9a961" stroke-width="2"/>
        <path d="M 150 210 Q 200 180 250 210" fill="none" stroke="#c9a961" stroke-width="2"/>
        <ellipse cx="200" cy="150" rx="80" ry="60" fill="none" stroke="#c9a961" stroke-width="3" opacity="0.5"/>
        <text x="200" y="270" font-family="Georgia" font-size="16" fill="#c9a961" text-anchor="middle" font-style="italic">Two become one</text>
      </svg>`,

      gate3: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <line x1="200" y1="60" x2="200" y2="240" stroke="#c9a961" stroke-width="3"/>
        <line x1="100" y1="60" x2="300" y2="60" stroke="#c9a961" stroke-width="3"/>
        <line x1="110" y1="60" x2="110" y2="90" stroke="#c9a961" stroke-width="2"/>
        <line x1="290" y1="60" x2="290" y2="90" stroke="#c9a961" stroke-width="2"/>
        <rect x="90" y="90" width="40" height="30" fill="none" stroke="#c9a961" stroke-width="2"/>
        <rect x="270" y="90" width="40" height="30" fill="none" stroke="#c9a961" stroke-width="2"/>
        <circle cx="200" cy="250" r="20" fill="none" stroke="#c9a961" stroke-width="3"/>
        <text x="200" y="285" font-family="Georgia" font-size="16" fill="#c9a961" text-anchor="middle" font-style="italic">Act of Pappa?</text>
      </svg>`,

      gate4: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <circle cx="200" cy="120" r="70" fill="none" stroke="#c9a961" stroke-width="3"/>
        <text x="200" y="130" font-family="Georgia" font-size="24" fill="#c9a961" text-anchor="middle" font-weight="bold">?</text>
        <text x="200" y="280" font-family="Georgia" font-size="14" fill="#c9a961" text-anchor="middle" font-style="italic">pleasure of bouba</text>
      </svg>`,

      gate5: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <path d="M 200 80 L 180 140 L 220 140 Z" fill="none" stroke="#c9a961" stroke-width="3"/>
        <path d="M 200 140 L 180 200 L 220 200 Z" fill="none" stroke="#c9a961" stroke-width="3"/>
        <path d="M 200 200 L 170 260 L 230 260 Z" fill="none" stroke="#c9a961" stroke-width="3"/>
        <circle cx="200" cy="65" r="8" fill="#c9a961"/>
        <line x1="150" y1="260" x2="250" y2="260" stroke="#c9a961" stroke-width="4"/>
        <text x="200" y="285" font-family="Georgia" font-size="14" fill="#c9a961" text-anchor="middle" font-style="italic">Time transforms through heat</text>
      </svg>`,

      gate6: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <circle cx="200" cy="120" r="50" fill="none" stroke="#c9a961" stroke-width="3" stroke-dasharray="10,5"/>
        <text x="200" y="130" font-family="Georgia" font-size="36" fill="#c9a961" text-anchor="middle">?</text>
        <path d="M 140 170 L 200 220 L 260 170" fill="none" stroke="#c9a961" stroke-width="3"/>
        <text x="200" y="255" font-family="Georgia" font-size="16" fill="#c9a961" text-anchor="middle">Culture</text>
        <text x="200" y="285" font-family="Georgia" font-size="14" fill="#c9a961" text-anchor="middle" font-style="italic">The question that seeks place</text>
      </svg>`,

      gate7: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <g transform="translate(50, 50)">
          <text x="0" y="0" font-family="Courier" font-size="20" fill="#888" letter-spacing="8">F ░ L ░ T ░ E</text>
          <text x="0" y="35" font-family="Courier" font-size="20" fill="#888" letter-spacing="8">░ I ░ A ░ M ░</text>
          <text x="0" y="70" font-family="Courier" font-size="20" fill="#888" letter-spacing="8">░ ░ T ░ R ░ A</text>
          <text x="0" y="105" font-family="Courier" font-size="20" fill="#888" letter-spacing="8">░ R░ ░ B ░ E ░</text>
          <text x="0" y="140" font-family="Courier" font-size="20" fill="#888" letter-spacing="8">░ E░ ░G ░ I ░ S </text>
          <text x="0" y="175" font-family="Courier" font-size="20" fill="#888" letter-spacing="8">░ ░ ░ ░ ░ L ░</text>
        </g>
        <text x="200" y="285" font-family="Georgia" font-size="14" fill="#c9a961" text-anchor="middle" font-style="italic">Look through. Not at.</text>
      </svg>`,

      gate8: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <circle cx="120" cy="120" r="40" fill="none" stroke="#888" stroke-width="2"/>
        <text x="120" y="130" font-family="Georgia" font-size="16" fill="#888" text-anchor="middle">KNOWN</text>
        <circle cx="280" cy="120" r="40" fill="none" stroke="#c9a961" stroke-width="3"/>
        <text x="280" y="130" font-family="Georgia" font-size="16" fill="#c9a961" text-anchor="middle">?</text>
        <path d="M 120 170 L 120 210 M 280 170 L 280 210" stroke="#c9a961" stroke-width="2"/>
        <text x="120" y="230" font-family="Georgia" font-size="12" fill="#888" text-anchor="middle">Innate</text>
        <text x="280" y="230" font-family="Georgia" font-size="12" fill="#c9a961" text-anchor="middle">Earned</text>
        <text x="200" y="275" font-family="Georgia" font-size="14" fill="#c9a961" text-anchor="middle" font-style="italic">Through time and repetition</text>
      </svg>`,

      gate9: `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="400" height="300" fill="#1a1a1a"/>
        <path d="M 150 60 L 250 60 L 220 110 L 200 150 L 180 110 Z" fill="none" stroke="#c9a961" stroke-width="3"/>
        <circle cx="200" cy="150" r="5" fill="#c9a961"/>
        <path d="M 180 190 L 200 150 L 220 190 L 250 240 L 150 240 Z" fill="none" stroke="#c9a961" stroke-width="3"/>
        <line x1="140" y1="60" x2="260" y2="60" stroke="#c9a961" stroke-width="3"/>
        <line x1="140" y1="240" x2="260" y2="240" stroke="#c9a961" stroke-width="3"/>
        <text x="200" y="280" font-family="Georgia" font-size="14" fill="#c9a961" text-anchor="middle" font-style="italic">Time bound, yet timeless</text>
      </svg>`
    };

    // ========= APP =========
    function App() {
      const [progress, setProgress] = useState({
        currentGate: 1,
        completedGates: [],
        awaitingHost: false,
        gameComplete: false,
        attempts: {}
      });

      // NEW: endgame stages
      // 'gates' -> normal gates
      // 'phrase' -> user must type FINAL_PHRASE (not shown)
      // 'destination' -> guess destination word (Turkey)
      // 'jigsaw' -> 32-piece image fallback
      // 'reveal' -> reveal
      const [endStage, setEndStage] = useState('gates');
      const [destAttempts, setDestAttempts] = useState(0);

      const [feedback, setFeedback] = useState(null);
      const [showAdmin, setShowAdmin] = useState(false);
      const [answer, setAnswer] = useState('');
      const [gate5Grid, setGate5Grid] = useState(Array(14).fill(''));

      const logAttempt = (gate, attempt, correct) => {
        const key = `gate_${gate}`;
        setProgress(prev => ({
          ...prev,
          attempts: {
            ...prev.attempts,
            [key]: [...(prev.attempts[key] || []), { attempt, correct, timestamp: new Date().toISOString() }]
          }
        }));
      };

      const successMsg = (gate) => ({
        1: 'Permission granted.',
        2: 'Unified.',
        3: 'Sovereignty achieved.',
        4: 'The invariant revealed.',
        5: 'Ancient wisdom revealed.',
        6: 'The inquiry stands.',
        7: 'Light breaks through.',
        8: 'Knowledge earned.',
        9: 'The final virtue embodied.'
      }[gate] || 'Truth.');

      const errorMsg = (gate) => ({
        1: 'The gate remains closed.',
        2: 'Division persists.',
        3: 'External forces bind you.',
        4: 'It changes. Try again.',
        5: 'The wisdom eludes you.',
        6: 'The question is wrong.',
        7: 'Still in darkness.',
        8: 'Not yet acquired.',
        9: 'Haste defeats you.'
      }[gate] || 'No.');

      const passGate = (gate) => {
        setTimeout(() => {
          if (gate === 9) {
            // NEW: do not reveal phrase. Move to phrase-input stage.
            setProgress(prev => ({ ...prev, completedGates: [...prev.completedGates, gate] }));
            setEndStage('phrase');
          } else {
            setProgress(prev => ({
              ...prev,
              awaitingHost: true,
              completedGates: [...prev.completedGates, gate]
            }));
          }
          setAnswer('');
          setFeedback(null);
        }, 1200);
      };

      const checkAnswer = (gate, correct, user) => {
        const norm = user.trim().toUpperCase();
        if (norm === correct) {
          setFeedback({ type: 'success', message: successMsg(gate) });
          logAttempt(gate, user, true);
          passGate(gate);
        } else {
          setFeedback({ type: 'error', message: errorMsg(gate) });
          logAttempt(gate, user, false);
        }
      };

      const submitGate5 = () => {
        const correctPhrase = ['IR','SL','AT',' F','EN','E ','OW','MA','S ','ME',' T','KE','DE','R'];
        const userPhrase = gate5Grid.filter(Boolean).join('');
        const correctFull = correctPhrase.join('');
        if (userPhrase === correctFull || userPhrase.replace(/\s/g,'') === 'SLOWFIREMAKESMEATTENDER') {
          setFeedback({ type: 'success', message: successMsg(5) });
          logAttempt(5, gate5Grid.join(''), true);
          setTimeout(() => {
            setProgress(prev => ({ ...prev, awaitingHost: true, completedGates: [...prev.completedGates, 5] }));
            setGate5Grid(Array(14).fill(''));
            setFeedback(null);
          }, 1200);
        } else {
          setFeedback({ type: 'error', message: errorMsg(5) });
          logAttempt(5, gate5Grid.join(''), false);
        }
      };

      const hostApprove = (pin) => {
        if (pin === HOST_PIN) {
          setProgress(prev => ({ ...prev, currentGate: prev.currentGate + 1, awaitingHost: false }));
          setShowAdmin(false);
          setFeedback({ type: 'success', message: 'Passage granted.' });
          setTimeout(() => setFeedback(null), 900);
        } else {
          setFeedback({ type: 'error', message: 'Denied.' });
        }
      };

      const resetAll = () => { if (confirm('Restart from the beginning?')) window.location.reload(); };

      // ===== NEW: phrase stage submit =====
      const submitFinalPhrase = () => {
        const norm = answer.trim().replace(/\s+/g, ' ').toUpperCase();
        if (norm === FINAL_PHRASE) {
          setFeedback({ type: 'success', message: 'The sentence is forged. Now name the place.' });
          setTimeout(() => {
            setFeedback(null);
            setAnswer('');
            setEndStage('destination');
          }, 900);
        } else {
          setFeedback({ type: 'error', message: 'Not assembled. Combine every gate.' });
        }
      };

      // ===== NEW: destination guess submit =====
      const submitDestination = () => {
        const norm = answer.trim().toUpperCase();
        const ok = DESTINATION_ACCEPT.includes(norm);
        if (ok) {
          setFeedback({ type: 'success', message: 'Correct. The veil lifts.' });
          setTimeout(() => {
            setFeedback(null);
            setEndStage('reveal');
          }, 900);
        } else {
          const next = destAttempts + 1;
          setDestAttempts(next);

          if (next >= DESTINATION_MAX_ATTEMPTS) {
            setFeedback({ type: 'error', message: 'Then prove it. Rebuild the image.' });
            setTimeout(() => {
              setFeedback(null);
              setAnswer('');
              setEndStage('jigsaw');
            }, 900);
          } else {
            setFeedback({ type: 'error', message: `No. (${next}/${DESTINATION_MAX_ATTEMPTS}) Try again.` });
          }
        }
      };

      // ===== NEW: render endgame screens =====
      if (endStage === 'phrase') {
        return (
          <>
            <AdminPanel onApprove={hostApprove} onReset={resetAll} progress={progress} show={showAdmin} setShow={setShowAdmin} />
            <div className="container">
              <h1 className="title">Initiation</h1>
              {feedback && <div className={`feedback ${feedback.type}`}>{feedback.message}</div>}

              <h2 className="gate-title">THE KEY ASSEMBLY</h2>
              <div className="gate-content">
                <div className="verse">
                  Now you have the keys to unlock.<br/>
                  Combine the answers of all gates into one sentence.<br/>
                  Do not guess — forge it.
                </div>
                <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                  Write the full sentence (all words, in order).
                </p>
              </div>

              <input
                type="text"
                placeholder="Type the full sentence"
                value={answer}
                onChange={(e) => setAnswer(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && submitFinalPhrase()}
              />
              <button onClick={submitFinalPhrase}>Unlock</button>
            </div>
          </>
        );
      }

      if (endStage === 'destination') {
        return (
          <>
            <AdminPanel onApprove={hostApprove} onReset={resetAll} progress={progress} show={showAdmin} setShow={setShowAdmin} />
            <div className="container">
              <h1 className="title">Initiation</h1>
              {feedback && <div className={`feedback ${feedback.type}`}>{feedback.message}</div>}

              <h2 className="gate-title">DESTINATION</h2>
              <div className="gate-content">
                <div className="verse">
                  You have the sentence.<br/>
                  Now speak the place.
                </div>
                <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                  One word. Country. No hints.
                </p>
              </div>

              <input
                type="text"
                placeholder="Destination (one word)"
                value={answer}
                onChange={(e) => setAnswer(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && submitDestination()}
              />
              <button onClick={submitDestination}>Declare</button>

              <button
                onClick={() => { setEndStage('jigsaw'); setFeedback(null); setAnswer(''); }}
                style={{ opacity: 0.85 }}
              >
                I give up. Show me the puzzle.
              </button>
            </div>
          </>
        );
      }

      if (endStage === 'jigsaw') {
        return (
          <div className="container" style={{ paddingTop:'40px' }}>
            <div style={{
              fontSize:'clamp(1.2rem, 5vw, 1.8rem)',
              color:'#c9a961',
              textAlign:'center',
              margin:'30px 0',
              fontStyle:'italic'
            }}>
              No more words.
            </div>

            <div style={{
              fontSize:'clamp(1rem, 4.5vw, 1.5rem)',
              textAlign:'center',
              color:'#d0d0d0',
              fontStyle:'italic',
              margin:'20px 0 10px',
              lineHeight:2
            }}>
              Rebuild the image to earn the answer.
            </div>

            <JigsawPuzzle32 onComplete={() => setEndStage('reveal')} />
          </div>
        );
      }

      if (endStage === 'reveal') {
        return <FinalRevealScreen />;
      }

      // ===== normal gates flow =====
      if (progress.awaitingHost) {
        return (
          <>
            <AdminPanel onApprove={hostApprove} onReset={resetAll} progress={progress} show={showAdmin} setShow={setShowAdmin} />
            <div style={{ textAlign:'center', padding:'80px 20px', minHeight:'70vh' }}>
              <h2 style={{ fontSize:'2rem', margin:'40px 0', letterSpacing:'6px', fontWeight:300, color:'#c9a961' }}>
                Return to Kiki.
              </h2>
              <div style={{ color:'#888', fontStyle:'italic', marginTop:'30px' }}>
                The gate yields. Await the seal.
              </div>
            </div>
          </>
        );
      }

      return (
        <>
          <AdminPanel onApprove={hostApprove} onReset={resetAll} progress={progress} show={showAdmin} setShow={setShowAdmin} />
          <div className="container">
            <h1 className="title">Initiation</h1>
            {feedback && <div className={`feedback ${feedback.type}`}>{feedback.message}</div>}

            <Gate
              number={progress.currentGate}
              answer={answer}
              setAnswer={setAnswer}
              gate5Grid={gate5Grid}
              setGate5Grid={setGate5Grid}
              onSubmit={() => {
                if (progress.currentGate === 5) submitGate5();
                else checkAnswer(progress.currentGate, GATES[progress.currentGate].answer, answer);
              }}
            />
          </div>
        </>
      );
    }

    function AdminPanel({ onApprove, onReset, progress, show, setShow }) {
      const [pin, setPin] = useState('');
      const [authed, setAuthed] = useState(false);
      const [showKeys, setShowKeys] = useState(false);

      const submitPin = () => {
        if (pin === HOST_PIN) setAuthed(true);
        else { alert('Denied'); setPin(''); }
      };

      const grant = () => { onApprove(pin); setPin(''); setAuthed(false); };

      const close = () => { setShow(false); setAuthed(false); setPin(''); setShowKeys(false); };

      return (
        <>
          <button className="admin-btn" onClick={() => setShow(true)}>⚙</button>
          <div className={`modal ${show ? 'active' : ''}`} onClick={close}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3 style={{ marginBottom:'18px', letterSpacing:'3px', textAlign:'center', color:'#c9a961' }}>
                HOST PANEL
              </h3>

              {!authed ? (
                <div>
                  <p style={{ marginBottom:'18px', color:'#888', textAlign:'center' }}>Enter host seal</p>
                  <input
                    type="password"
                    placeholder="PIN"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && submitPin()}
                  />
                  <button onClick={submitPin}>Authenticate</button>
                  <button onClick={close}>Cancel</button>
                </div>
              ) : (
                <div>
                  <div style={{ marginBottom:'12px', color:'#999' }}>
                    Gate: {progress.currentGate} | Completed: {progress.completedGates.join(', ') || 'None'}
                  </div>

                  {progress.awaitingHost && (
                    <div style={{ marginTop:'18px', marginBottom:'18px' }}>
                      <p style={{ color:'#81c784', marginBottom:'12px' }}>
                        ✓ Gate {progress.completedGates[progress.completedGates.length - 1]} complete
                      </p>
                      <button onClick={grant}>Grant Passage</button>
                    </div>
                  )}

                  <button onClick={onReset}>Reset All</button>
                  <button onClick={() => setShowKeys(!showKeys)}>{showKeys ? 'Hide' : 'Show'} Keys</button>

                  {showKeys && (
                    <div style={{ marginTop:'12px', padding:'12px', background:'rgba(0,0,0,0.5)', fontSize:'0.9rem' }}>
                      {Object.entries(GATES).map(([num, gate]) => (
                        <div key={num} style={{ margin:'5px 0', color:'#c9a961' }}>
                          {num}: {gate.answer}
                        </div>
                      ))}
                    </div>
                  )}

                  <button onClick={close}>Close</button>
                </div>
              )}
            </div>
          </div>
        </>
      );
    }

    // ===== FINAL REVEAL SCREEN =====
    function FinalRevealScreen() {
      return (
        <div className="final-reveal">
          <div style={{
            fontSize:'clamp(2rem, 12vw, 5rem)',
            letterSpacing:'clamp(5px, 3vw, 15px)',
            color:'#c9a961',
            marginBottom:'30px',
            fontWeight:'300'
          }}>
            TURKEY
          </div>

          <img
            src="./turkey.jpg"
            alt="Turkey"
            style={{
              width:'min(560px, 92vw)',
              border:'1px solid rgba(201,169,97,0.35)',
              boxShadow:'0 0 25px rgba(0,0,0,0.35)',
              borderRadius:'6px'
            }}
          />

          <div style={{
            fontSize:'clamp(1rem, 4vw, 1.35rem)',
            color:'#d0d0d0',
            fontStyle:'italic',
            maxWidth:'92%',
            margin:'34px auto 0',
            lineHeight:2
          }}>
            Where ancient fires still burn slow.<br/>
            Where patience transforms meat to art.<br/>
            Where we shall judge kebab together.
          </div>
        </div>
      );
    }

    // ===== 32-PIECE IMAGE JIGSAW (8x4) =====
    function JigsawPuzzle32({ onComplete }) {
      const GRID_COLS = 8;
      const GRID_ROWS = 4;
      const N = GRID_COLS * GRID_ROWS; // 32
      const IMG = './turkey.jpg';

      const [pieces, setPieces] = useState(() => {
        const positions = Array.from({ length: N }, (_, i) => i);
        for (let i = positions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        return positions.map((pos, id) => ({ id, currentPos: pos }));
      });

      const [selectedId, setSelectedId] = useState(null);

      const solved = (arr) => arr.every(p => p.id === p.currentPos);

      const click = (id) => {
        if (selectedId === null) { setSelectedId(id); return; }
        if (selectedId === id) { setSelectedId(null); return; }

        setPieces(prev => {
          const next = prev.map(p => ({ ...p }));
          const i1 = next.findIndex(p => p.id === selectedId);
          const i2 = next.findIndex(p => p.id === id);
          const tmp = next[i1].currentPos;
          next[i1].currentPos = next[i2].currentPos;
          next[i2].currentPos = tmp;

          if (solved(next)) setTimeout(() => onComplete(), 900);
          return next;
        });

        setSelectedId(null);
      };

      const placed = [...pieces].sort((a,b) => a.currentPos - b.currentPos);

      const styleFor = (tile) => {
        const row = Math.floor(tile.id / GRID_COLS);
        const col = tile.id % GRID_COLS;

        return {
          backgroundImage: `url(${IMG})`,
          backgroundSize: `${GRID_COLS * 100}% ${GRID_ROWS * 100}%`,
          backgroundPosition: `${(col * 100) / (GRID_COLS - 1)}% ${(row * 100) / (GRID_ROWS - 1)}%`,
          border: selectedId === tile.id ? '3px solid #c9a961' : '2px solid rgba(201, 169, 97, 0.35)',
          boxShadow: selectedId === tile.id ? '0 0 18px rgba(201, 169, 97, 0.85)' : 'none',
          transform: selectedId === tile.id ? 'scale(0.96)' : 'scale(1)',
          borderRadius: '2px'
        };
      };

      return (
        <div className="jigsaw-container">
          <div style={{
            fontSize:'clamp(1rem, 4vw, 1.25rem)',
            color:'#c9a961',
            textAlign:'center',
            marginBottom:'12px',
            fontStyle:'italic',
            lineHeight:1.6
          }}>
            Tap a piece, then tap another.<br/>
            They will swap. Form the image.
          </div>

          <div className="jigsaw-scroll">
            <div className="jigsaw-grid">
              {placed.map(tile => (
                <div
                  key={tile.id}
                  className="jigsaw-piece"
                  onClick={() => click(tile.id)}
                  style={styleFor(tile)}
                  title="tap to swap"
                />
              ))}
            </div>
          </div>

          <div style={{ textAlign:'center', marginTop:'12px', color:'#888', fontSize:'0.85rem', fontStyle:'italic' }}>
            Selected piece glows gold.<br/>
            On small screens, scroll sideways. No mercy.
          </div>
        </div>
      );
    }

    // ===== GATE RENDERING =====
    function Gate({ number, answer, setAnswer, gate5Grid, setGate5Grid, onSubmit }) {
      const SVGImage = ({ data, caption }) => (
        <div className="image-container">
          <div dangerouslySetInnerHTML={{ __html: data }} />
          {caption && <div className="image-caption">{caption}</div>}
        </div>
      );

      const gates = {
        1: (
          <>
            <h2 className="gate-title">GATE I</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate1} caption="The key is within the lock" />
              <div className="verse">
                The door asks permission of itself.<br/>
                The word that opens is the word that grants.<br/>
                No key exists outside the lock.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                What single syllable permits its own utterance?
              </p>
            </div>
            <input
              type="text"
              placeholder="Speak the word"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        2: (
          <>
            <h2 className="gate-title">GATE II</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate2} caption="Two circles merge into one" />
              <div className="verse">
                Two rivers meet without speaking.<br/>
                Two flames merge without negotiation.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                Not I. Not you. What remains?
              </p>
            </div>
            <input
              type="text"
              placeholder="The word of unity"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        3: (
          <>
            <h2 className="gate-title">GATE III</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate3} caption="The scales of sovereignty" />
              <div className="verse">
                Like the storm, it arrives.<br/>
                And stays like the cloud above your head.<br/>
                You cannot stop it.<br/>
                Nor can you escape it.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                You fear this quality of Pappa and Mamma all the time.
              </p>
            </div>
            <input
              type="text"
              placeholder="The act of pappa"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        4: (
          <>
            <h2 className="gate-title">GATE IV</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate4} caption="One word, of our Nordstadt" />
              <div className="verse">
                Watching through our window.<br/>
                Across Bodestrasse 8.<br/>
                Forges spanning the rails.<br/>
                Aroma persuades your dream.<br/>
                Relishing with a Pessoa on hand,<br/>
                and me beside you watching the lane.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                Which dream needs no waiting, though I despise?
              </p>
            </div>
            <input
              type="text"
              placeholder="The unchanging name"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        5: (
          <>
            <h2 className="gate-title">GATE V</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate5} caption="Fire descends to the hearth" />
              <div className="verse">
                The ancients knew what haste forgets.<br/>
                Time is the ingredient of the taste.
              </div>

              <div className="grid-container">
                {gate5Grid.map((cell, i) => (
                  <div key={i} className="grid-cell">{cell || (i + 1)}</div>
                ))}
              </div>

              <div style={{ textAlign:'center', marginTop:'14px', display:'flex', flexWrap:'wrap', justifyContent:'center' }}>
                {['AT','SL','EN','IR','S ','OW','DE','MA',' T','KE','E ',' F','ME','R'].map((tile, i) => (
                  <div
                    key={i}
                    className="tile-option"
                    onClick={() => {
                      if (gate5Grid.includes(tile)) return;
                      const empty = gate5Grid.findIndex(c => !c);
                      if (empty !== -1) {
                        const next = [...gate5Grid];
                        next[empty] = tile;
                        setGate5Grid(next);
                      }
                    }}
                    style={{ opacity: gate5Grid.includes(tile) ? 0.25 : 1 }}
                  >
                    {tile}
                  </div>
                ))}
              </div>
            </div>
            <button onClick={onSubmit}>Submit</button>
            <button onClick={() => setGate5Grid(Array(14).fill(''))}>Clear</button>
          </>
        ),

        6: (
          <>
            <h2 className="gate-title">GATE VI</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate6} caption="The question mark above culture" />
              <div className="verse">
               Location is not coordinates on parchment.<br/>
               Precedes the voyages from the dawn of time <br/>
               The question precedes the answer.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
               Our frequent adverb, often, to ask?
              </p>
            </div>
            <input
              type="text"
              placeholder="The question of place"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        7: (
          <>
            <h2 className="gate-title">GATE VII</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate7} caption="A lattice of ash and meaning" />
              <div className="verse">
                 element of life <br/>
                 Virtue of which  you like the most !<br/>
                 Look through them.<br/>
              </div>
            </div>
            <input
              type="text"
              placeholder="The hidden word"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        8: (
          <>
            <h2 className="gate-title">GATE VIII</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate8} caption="Two forms of knowledge" />
              <div className="verse">
                That which arrives with birth—<br/>
                Possessed without , but drives us to know.<br/>
                Brahman does this to be.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                knowledge  earned through time
              </p>
            </div>
            <input
              type="text"
              placeholder="Knowledge through time"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        ),

        9: (
          <>
            <h2 className="gate-title">GATE IX</h2>
            <div className="gate-content">
              <SVGImage data={IMAGES.gate9} caption="The hourglass of virtue" />
              <div className="verse">
                Practice cultivates it.<br/><br/>
                Time teaches it to humans.
              </div>
              <p style={{ textAlign:'center', color:'#d0d0d0', fontStyle:'italic' }}>
                " I am that;  To wait."
              </p>
            </div>
            <input
              type="text"
              placeholder="The final virtue"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
            />
            <button onClick={onSubmit}>Submit</button>
          </>
        )
      };

      return gates[number] || <div>Gate not found</div>;
    }

    // Mount
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
